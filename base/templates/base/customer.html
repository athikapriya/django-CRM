{% extends 'base/main.html' %}

{% block css %}
<style>
    #order-filter-form select,
    #order-filter-form input {
        height: 34px;
        font-size: 0.85rem;
    }

    #order-filter-form {
        margin-bottom: 0;
    }

    .table-responsive table {
        min-width: 900px;
    }

    .table-nowrap th,
    .table-nowrap td {
        white-space: nowrap;
    }

</style>
{% endblock %}


{% block content %}

<section id="customer">
    <div class="container">

        <!-- first section starts -->
        <div class="row mb-4">
            
            <!-- customer updating section -->
            <div class="col-md-4 g-4">
                <div class="card card-body">
                    <h3 class="fw-semibold">Customer : </h3>
                    <hr>
                    <a href="" class="btn btn-sm btn-outline-primary mb-2">Update Customer</a>
                    <a href="{% url 'create_order' customer.id %}?next={% url 'customer' customer.id %}" class="btn btn-sm btn-outline-primary">Place Order</a>
                </div>
            </div>

            <!-- customer info -->
            <div class="col-md-4 g-4">
                <div class="card card-body">
                    <h3 class="fw-semibold">Customer Info :</h3>
                    <hr>
                    <p><span class="fw-semibold">Email</span> : {{ customer.email }} </p>
                    <p class="mb-1"><span class="fw-semibold">Phone</span> : {{ customer.phone }}</p>
                </div>
            </div>

            <!-- total orders -->
            <div class="col-md-4 g-4">
                <div class="card card-body">
                    <h3 class="fw-semibold">Total Orders :</h3>
                    <hr>
                    <p class="text-center fs-3" style="padding: 6px;">{{ total_order }}</p>
                </div>
            </div>
        </div>
        <!-- first section ends -->



        <!-- FILTER SECTION -->
        <div class="row my-3">
            <div class="card card-body py-3">

                <form method="get" id="order-filter-form">

                    <!-- COMPACT ROW -->
                    <div class="row gx-2 gy-2 align-items-end">

                        <!-- Product -->
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label small fw-semibold mb-1">
                                Product
                            </label>
                            {{ myFilter.form.product }}
                        </div>

                        <!-- Status -->
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label small fw-semibold mb-1">
                                Status
                            </label>
                            {{ myFilter.form.status }}
                        </div>

                        <!-- From date -->
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label small fw-semibold mb-1">
                                From
                            </label>
                            {{ myFilter.form.start_date }}
                        </div>

                        <!-- To date -->
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label small fw-semibold mb-1">
                                To
                            </label>
                            {{ myFilter.form.end_date }}
                        </div>

                        <!-- Note search -->
                        <div class="col-12 col-lg-3">
                            <label class="form-label small fw-semibold mb-1">
                                Keyword
                            </label>
                            {{ myFilter.form.note }}
                        </div>

                        <!-- Clear -->
                        <div class="col-12 col-lg-1 text-lg-end">
                            <a href="{% url 'customer' customer.id %}"
                            class="btn btn-primary btn-sm w-100 mt-1">
                                Clear
                            </a>
                        </div>

                    </div>

                </form>

            </div>
        </div>
        <!-- FILTER SECTION END -->


        <!-- third section starts -->
        <div class="row my-4">
            <div class="card card-body">
                <div class="table-responsive">
                    <table class="table table-sm align-middle table-bordered table-nowrap table-hover">
                        <tr>
                            <th>Product</th>
                            <th>Remarks</th>
                            <th>Category</th>
                            <th>Date Ordered</th>
                            <th>Status</th>
                            <th class="text-center">Update</th>
                            <th class="text-center">Remove</th>
                        </tr>

                        {% for order in orders %}
                            <tr>
                                <td class="fw-semibold">
                                    <i class="bi bi-box-seam me-1 text-secondary"></i>
                                    {{ order.product.name }}
                                </td>
                                <td style="max-width: 220px;">
                                    {% if order.note %}
                                        <span 
                                            class="text-truncate d-inline-block"
                                            style="max-width: 200px;"
                                            title="{{ order.note }}"
                                        >
                                            {{ order.note }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted fst-italic">No remarks</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark border">
                                        {{ order.product.category }}
                                    </span>
                                </td>
                                <td class="text-muted">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    {{ order.date_created|date:"M j, Y" }}
                                </td>
                                <td>
                                    {% if order.status == "Delivered" %}
                                        <span class="badge bg-success">{{ order.status }}</span>
                                    {% elif order.status == "Pending" %}
                                        <span class="badge bg-warning text-dark">{{ order.status }}</span>
                                    {% else %}
                                        <span class="badge bg-info">{{ order.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'update_order' order.id %}?next={% url 'customer' customer.id %}"
                                    class="btn btn-sm btn-outline-primary"
                                    title="Update" >
                                        <i class="fa-regular fa-pen-to-square"></i>
                                    </a>
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'delete_order' order.id %}?next={% url 'customer' customer.id %}"
                                    class="btn btn-sm btn-outline-danger"
                                    title="Delete">
                                        <i class="fa-solid fa-trash-arrow-up"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
        <!-- third section ends -->

    </div>
</section>

{% endblock %}


<!-- js for note auto filter -->
{% block scripts %}

<script>

    function debounce(fn, delay = 500) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("order-filter-form");
        if (!form) return;

        const autoInputs = form.querySelectorAll("[data-auto-submit]");

        autoInputs.forEach(input => {
            const eventType = input.tagName === "SELECT" ? "change" : "input";

            input.addEventListener(
                eventType,
                debounce(() => form.submit())
            );
        });
    });

</script>
{% endblock %}
<!-- js for note auto filter -->